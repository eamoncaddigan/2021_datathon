---
title: "R Notebook"
output: html_notebook
---

Exploring the `grades` column.

```{r}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(rprojroot))
```

In this notebook I'm only going to examine data that are present in the `offenses_dispositions` data file. 

```{r}
dispositions <- read_csv(file.path(find_root(is_rstudio_project), "data",
                                   "offenses_dispositions_v3_periods.csv"),
                         col_types = cols(
  X1 = col_double(),
  docket_id = col_double(),
  description = col_character(),
  statute_description = col_character(),
  statute_name = col_character(),
  sequence_number = col_double(),
  grade = col_character(),
  disposition = col_character(),
  disposing_authority__first_name = col_character(),
  disposing_authority__middle_name = col_character(),
  disposing_authority__last_name = col_character(),
  disposing_authority__title = col_character(),
  disposing_authority__document_name = col_character(),
  disposition_method = col_character(),
  min_period = col_character(),
  max_period = col_character(),
  period = col_character(),
  credit = col_double(),
  sentence_type = col_factor(levels = c("No Further Penalty",
                                        "Merged",
                                        "Probation",
                                        "IPP",
                                        "Confinement")),
  min_period_parsed = col_character(),
  max_period_parsed = col_character(),
  min_period_days = col_double(),
  max_period_days = col_double()
))
```

Let's look at grades and sentence types.

```{r}
dispositions %>%
  filter(!is.na(sentence_type), !is.na(grade)) %>%
  ggplot(aes(sentence_type)) +
  geom_bar() +
  coord_flip() +
  facet_wrap(~ grade, scales = "free_x") +
  theme_minimal()
```

I don't know what's up with the `grade` values of H1, H2, IC, and I also don't know what's going on with S, M, and F without a number.

```{r}
dispositions %>%
  filter(grade %in% c("H1", "H2")) %>%
  count(grade, statute_name) %>%
  arrange(grade, desc(n)) %>%
  group_by(grade) %>%
  slice(1:5)
```

H stands for "homicide", 18 § 2502 §§ A is murder of the first degree and 18 § 2502 §§ B is murder of the second degree (which could have been as a F1, but was not). 

```{r}
dispositions %>%
  filter(statute_name == "18 § 2502 §§ B") %>%
  count(grade)
```

What about "IC"?

```{r}
dispositions %>%
  filter(grade == "IC") %>%
  count(statute_name) %>%
  arrange(desc(n)) %>%
  head(10)
```

# Cleaning up `NA`s.

How often is `grade` NA but a `statute_name` available, anyway?

```{r}
dispositions %>%
  filter(is.na(grade),
         !is.na(statute_name)) %>%
  nrow()
```

Whoa, that's a lot. 

For each statute name, find the most common grade, and the percentage of instances of that statute for which that grade is selected.

```{r}
most_popular_grade <- dispositions %>%
  filter(!is.na(grade), !is.na(statute_name)) %>%
  count(grade, statute_name, name = "num_dispositions") %>%
  group_by(statute_name) %>%
  mutate(statute_pct = 100 * num_dispositions / sum(num_dispositions)) %>%
  slice(1) %>%
  ungroup() 

most_popular_grade %>%
  arrange(statute_pct) %>%
  mutate(cum_density = row_number(statute_pct) / nrow(.)) %>%
  ggplot(aes(statute_pct, cum_density)) +
  geom_line() +
  theme_minimal()
```

This figure tells us that, for 75% of the `statute_name` values, a single `grade` accounts for 100% of the dispositions. We can use these cases to fill in missing `grade` values.

```{r}
most_popular_grade %>%
  filter(statute_pct > 100 - 1e-8) %>%
  select(statute_name, most_common_grade = grade) %>%
  right_join(dispositions, by = "statute_name") %>%
  mutate(grade = ifelse(is.na(grade), most_common_grade, grade)) %>%
  filter(is.na(grade),
         !is.na(statute_name)) %>%
  nrow()
```

This step recovers tens of thousands of missing `grade` values, so it's probably worth making this a function.


